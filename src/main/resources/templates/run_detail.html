<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	layout:decorate="~{layout}">
<head>


<meta charset="utf-8" />
<title th:text="${post.title}">ëŸ¬ë‹ ëª¨ì§‘ ìƒì„¸</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body {
	font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
		Arial, sans-serif;

}

.grid {
	display: grid;
	grid-template-columns: 4fr 3fr 3fr;
	gap: 24px;
	align-items: stretch;
}

.card {
	border: 1px solid #ddd;
	border-radius: 8px;
	padding: 16px;
	position: relative;
}

.card-footer {
	position: absolute;
	bottom: 16px;
	left: 16px;
	right: 16px;
	display: flex;
	align-items: center;
	gap: 12px;
}

.card-footer .btn {
	padding: 10px 15px;
	border-radius: 4px;
	background-color: #111;
	color: #fff;
	border: none;
	cursor: pointer;
	flex: none;
}

.footer-text {
	font-size: 14px;
	color: #666;
}

.content-card {
	border: 1px solid #ddd;
	border-radius: 12px;
	background: #fff;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
	padding: 8px;
	margin-bottom: 16px;
}

.content-card textarea {
	width: 100%;
	height: 120px;
	padding: 12px;
	border: none;
	outline: none;
	resize: none;
	font-size: 14px;
	line-height: 1.5;
	background: transparent;
}

#map {
	width: 100%;
	height: 520px;
	border-radius: 12px
}

.btn {
	background: #111;
	color: #fff;
	border: none;
	border-radius: 10px;
	padding: 12px 16px;
	cursor: pointer
}

.btn:disabled {
	opacity: .5;
	cursor: not-allowed
}

.stats {
	display: flex;
	gap: 12px;
	flex-wrap: wrap;
	margin-top: 8px
}

.stats div {
	background: #fafafa;
	border: 1px solid #eee;
	border-radius: 10px;
	padding: 8px 10px;
	font-size: 14px
}

.muted {
	color: #666
}

.time-range {
	font-size: 1.2em;
	font-weight: 600;
	color: #111;
}

.modal {
	display: none;
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0, 0, 0, 0.5);
	justify-content: center;
	align-items: center;
	z-index: 1000;
	opacity: 0;
	transition: opacity 0.3s ease;
}

.modal-content {
	background: #fff;
	padding: 20px;
	border-radius: 12px;
	max-width: 400px;
	width: 90%;
	text-align: center;
	transform: translateY(-20px);
	transition: transform 0.3s ease;
}

.modal-content .modal-actions {
    display: flex;
    justify-content: center; 
    gap: 12px;              
    margin-top: 16px;
}

.modal-content .modal-actions button {
    flex: none;             
    padding: 12px 18px;     
    font-size: 14px;        
    line-height: 1.2;       
    white-space: nowrap;      
    border-radius: 6px;
    cursor: pointer;
}

.modal.show {
	display: flex;
	opacity: 1;
}

.modal.show .modal-content {
	transform: translateY(0);
}

#modalClose {
	margin-top: 12px;
	padding: 8px 16px;
	border: none;
	border-radius: 8px;
	background: #111;
	color: #fff;
	cursor: pointer;
}

.reportBtn {
	background-color: #f0f0f0;
	color: #555;
	border: 1px solid #ccc;
	border-radius: 6px;
	padding: 3px 7px;
	font-size: 12px;
	cursor: pointer;
	transition: all 0.2s ease;
	margin-left: 8px;
}

.reportBtn:hover {
	background-color: #e0e0e0;
	border-color: #bbb;
}

.list-btn {
	display: inline-block;
	padding: 8px 16px;
	font-size: 16px;
	font-weight: 500;
	color: #1a73e8;
	border: 2px solid #1a73e8;
	border-radius: 6px;
	background: #fff;
	cursor: pointer;
	transition: all 0.2s ease;
	text-decoration: none;
}

.list-btn:hover {
	background-color: #1a73e8;
	color: #fff;
}
.delete-btn {
    display: inline-block;
    padding: 8px 16px;
    font-size: 16px;
    font-weight: 500;
    color: #dc3545;
    border: 2px solid #dc3545;
    border-radius: 6px;
    background: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    margin-left: 8px; 
}

.delete-btn:hover {
    background-color: #dc3545; 
    color: #fff;
}

.chat-container {
	display: flex;
	flex-direction: column;
	height: 100%;
}

.chat-header {
	font-weight: bold;
	padding: 8px 0;
	margin-bottom: 8px;
}

.chat-messages {
	flex: 1;
	overflow-y: auto;
	padding: 10px;
	border-top: 1px solid #ddd;
	border-bottom: 1px solid #ddd;
}

.chat-message {
	margin-bottom: 10px;
	display: flex;
}

.chat-message .bubble {
	max-width: 70%;
	padding: 10px 14px;
	border-radius: 16px;
	line-height: 1.4;
}

.chat-message.self {
	justify-content: flex-end;
}

.chat-message.self .bubble {
	background: #111;
	color: #fff;
	border-bottom-right-radius: 4px;
}

.chat-message.other .bubble {
	background: #e9ecef;
	color: #333;
	border-bottom-left-radius: 4px;
}

.chat-message .sender {
	font-size: 12px;
	margin-bottom: 4px;
	color: #666;
}

.chat-input {
	display: flex;
	gap: 8px;
	margin-top: 8px;
}

.chat-input input {
	flex: 1;
	padding: 8px 10px;
	border: 1px solid #ccc;
	border-radius: 6px;
	outline: none;
	font-size: 14px;
	box-sizing: border-box;
}

.chat-input button {
	padding: 8px 14px;
	border: none;
	border-radius: 6px;
	background-color: #000;
	color: #fff;
	cursor: pointer;
	transition: background 0.2s;
}

.chat-input button:hover {
	background-color: #333;
}

.user-item {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 8px 12px;
	margin-bottom: 4px;
	background: #f8f9fa;
	border-radius: 6px;
	border: 1px solid #e9ecef;
}

.user-name {
	font-weight: 500;
	color: #333;
	font-size: 14px;
}

.user-status {
	color: #28a745;
	font-size: 12px;
}

.system-message {
	text-align: center;
	margin: 8px 0;
}

.system-text {
	background: #e3f2fd;
	color: #1976d2;
	padding: 4px 12px;
	border-radius: 12px;
	font-size: 12px;
	font-weight: 500;
}
</style>
</head>
<body>
	<div layout:fragment="content">
<div style="display: inline-flex; align-items: center; gap: 8px; margin-bottom: 16px;">
    <h1 th:text="${post.title}" style="margin: 0; font-size: 1.8em;">ëŸ¬ë‹ ëª¨ì§‘ ìƒì„¸</h1>

    <th:block th:if="${canDelete}">
        <form th:action="@{|/community/running/run_delete/${post.postNum}|}" method="post" style="display:inline;">
            <button type="submit" class="delete-btn"
                style="padding: 4px 10px; font-size: 14px;" 
                onclick="return confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
                ì‚­ì œ
            </button>
        </form>
        <span style="color: #555; font-size: 13px;">ì°¸ì—¬ìê°€ ì—†ì„ ë•Œë§Œ ì‚­ì œ ê°€ëŠ¥í•©ë‹ˆë‹¤!</span>
    </th:block>
</div>

	<div class="grid">
		<!-- ì§€ë„ ì„¹ì…˜ -->
		<section class="card">
			<h2>ì½”ìŠ¤ ì§€ë„</h2>
			<div id="map"
				th:attr="data-pathjson=${course != null ? course.pathJson : null},
                  data-start-lat=${course != null ? course.startLat : null},
                  data-start-lng=${course != null ? course.startLng : null},
                  data-post-lat=${post.locationLat},
                  data-post-lng=${post.locationLng},
                  data-eta=${course != null ? course.estimatedTime : null}">
			</div>
			<div class="stats">
				<div>
					ì´ ê±°ë¦¬: <span id="distance">-</span>
				</div>
				<div>
					ì˜ˆìƒ ì‹œê°„: <span id="eta">-</span>
				</div>
				
				<div>
					ì‹œì‘ ì¢Œí‘œ: <span id="start">-</span>
				</div>

			</div>
		</section>

		<!-- ì •ë³´ ì„¹ì…˜ -->
		<aside class="card" style="padding-bottom: 60px;">
			<div class="card-body">

				<!-- ì¢…ë£Œëœ ëª¨ì„ ì•ˆë‚´ -->
				<div th:if="${#temporals.createNow().isAfter(post.endTime)}"
					style="padding: 12px; background: #f8d7da; color: #842029; border-radius: 8px; margin-bottom: 16px;">
					ì¢…ë£Œëœ ëª¨ì„ì…ë‹ˆë‹¤.</div>

				
<p class="muted"
    th:text="${#temporals.format(post.createDate, 'yyyy-MM-dd HH:mm')} + 'ì— ì‘ì„±ëœ ê¸€'">
    ì‘ì„±ì¼
</p>


				<!-- ë‚´ìš© -->
				<div class="content-card">
					<textarea readonly th:text="${post.content}"></textarea>
				</div>

				<p>
					<b>ë‚ ì§œ</b>: <span
						th:text="${#temporals.format(post.date, 'yyyy-MM-dd')}"></span>
				</p>
				<p>
					<b>ì‹œì‘</b>: <span
						th:text="${post.startTime != null ? post.startTime.toLocalTime() : '-'}"></span>
				</p>
				<p>
					<b>ì¢…ë£Œ</b>: <span
						th:text="${post.endTime != null ? post.endTime.toLocalTime() : '-'}"></span>
				</p>
				<p>
					<b>ìµœëŒ€ ì¸ì›</b>: <span th:text="${post.maxParticipants}">-</span>
				</p>
				<p>
					<b>í˜„ì¬ ì¸ì›</b>: <span id="currentParticipants"
						th:text="${post.currentParticipants}">-</span>
				</p>


				<ul>
					<li th:each="participant : ${participants}"><span
						th:text="${participant.userId}">ì‚¬ìš©ì ì´ë¦„</span>

						<button class="btn reportBtn"
							th:data-user-id="${participant.userNum}"
							th:if="${user != null and !user.isBlocked and user.userNum != participant.userNum}">
							ì‹ ê³ </button></li>
				</ul>

				<!-- ì°¸ì—¬/ì·¨ì†Œ ë²„íŠ¼ -->
				<div class="card-footer">
					<button id="joinBtn" class="btn"
						th:text="${joined} ? 'ì°¸ì—¬ ì·¨ì†Œ' : 'ì°¸ì—¬í•˜ê¸°'"
						th:disabled="${user == null 
                     or (user != null and user.isBlocked) or (isHost != null and isHost) 
                     or #temporals.createNow().isAfter(post.endTime) 
                     or (post.currentParticipants == post.maxParticipants and !joined)}">
					</button>

					<p th:if="${user == null}" style="color: red; margin-top: 8px;">ë¡œê·¸ì¸
						í›„ ì°¸ì—¬ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
					<p th:if="${isHost}" style="color: gray; margin-top: 8px;">ì‘ì„±ìëŠ”
						ì°¸ì—¬ ì·¨ì†Œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
					<p th:if="${user != null and user.isBlocked}"
						style="color: red; margin-top: 8px;">ê²½ê³  ëˆ„ì ìœ¼ë¡œ ì¸í•´ ëŸ¬ë‹ ì°¸ì—¬ê°€ ë¶ˆê°€í•©ë‹ˆë‹¤.</p>
				</div>

			</div>


		</aside>

		<!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ìë§Œ ì±„íŒ…ë°© í‘œì‹œ -->
		<aside class="card" sec:authorize="isAuthenticated()">
			<!-- user list -->
			<div class="chat-container" style="height:45%">
				<div class="chat-header">ìœ ì € ëª©ë¡</div>
				<div class="chat-messages" id="userList"></div>
			</div>
			<!-- ì‹¤ì‹œê°„ ì±„íŒ… -->
			<div class="chat-container" style="height:45%">
				<div class="chat-header">ì‹¤ì‹œê°„ ì±„íŒ…</div>
				<div class="chat-messages" id="chatMessages"></div>
				<div class="chat-input">
					<input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ ì…ë ¥..." />
					<button id="sendMessageBtn">ì „ì†¡</button>
				</div>
			</div>
		</aside>

		<!-- ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ì‚¬ìš©ìì—ê²Œ í‘œì‹œí•  ë©”ì‹œì§€ -->
		<aside class="card" sec:authorize="!isAuthenticated()">
			<div class="chat-container">
				<div class="chat-header">ì‹¤ì‹œê°„ ì±„íŒ…</div>
				<div class="chat-messages" style="text-align: center; padding: 20px; color: #666;">
					<p>ì±„íŒ… ê¸°ëŠ¥ì„ ì´ìš©í•˜ë ¤ë©´ ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.</p>
					<a th:href="@{/users/login}" class="btn btn-primary">ë¡œê·¸ì¸í•˜ê¸°</a>
				</div>
			</div>
		</aside>

	</div>

	<!-- ì¹´ë“œ ë°– ë²„íŠ¼ -->
	<div style="text-align: center; margin-top: 24px;">
		<a th:href="@{/community/running}" class="list-btn"> ëª©ë¡ë³´ê¸° </a>
	</div>





	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

	<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', () => {

    const postNum = /*[[${post.postNum}]]*/ 0;
    const user = /*[[${user}]]*/ {};
    const isAuthenticated = /*[[${#authentication != null}]]*/ false;
	
    // ë¡œê·¸ì¸ë˜ì§€ ì•Šì€ ê²½ìš° ì±„íŒ… ê¸°ëŠ¥ ë¹„í™œì„±í™”
    if (!isAuthenticated || !user || !user.userId) {
        console.log('ì‚¬ìš©ìê°€ ë¡œê·¸ì¸ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ì±„íŒ… ê¸°ëŠ¥ì´ ë¹„í™œì„±í™”ë©ë‹ˆë‹¤.');
        return;
    }
    console.log(user);

    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const userList = document.getElementById('userList');

    // ì±„íŒ… ìš”ì†Œê°€ ì¡´ì¬í•˜ì§€ ì•Šìœ¼ë©´ ì¢…ë£Œ
    if (!chatMessages || !messageInput || !sendMessageBtn || !userList) {
        console.log('ì±„íŒ… ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }

    let stompClient = null;
    let connectedUsers = new Set(); // ì—°ê²°ëœ ìœ ì € ëª©ë¡

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, onConnected);
    }
    
    function onConnected() {
        console.log('âœ… WebSocket Connected!');
        stompClient.subscribe('/topic/' + postNum, onMessageReceived);
        
        // í˜„ì¬ ìœ ì €ë¥¼ ëª©ë¡ì— ì¶”ê°€
        addUserToList(user.userId);
        
        // ìœ ì € ì…ì¥ ì•Œë¦¼ ë©”ì‹œì§€ ì „ì†¡
        sendUserJoinMessage();
    }

    function onMessageReceived(payload) {
        console.log("ğŸ“© Message Received:", payload.body);
        const message = JSON.parse(payload.body);
        
        // ë©”ì‹œì§€ íƒ€ì…ì— ë”°ë¼ ì²˜ë¦¬
        if (message.type === 'user_join') {
			console.log('!!!!!',message.users);
			if(message.users){
				message.users.forEach(id=>addUserToList(id))
			}
            //addUserToList(message.sender);
            displaySystemMessage(`${message.sender}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`);
        } else if (message.type === 'user_leave') {
            removeUserFromList(message.sender);
            displaySystemMessage(`${message.sender}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.`);
        } else {
            displayMessage(message);
        }
    }

    function sendMessage() {
        const messageContent = messageInput.value.trim();
        if (messageContent && stompClient && user && user.userId) {
            const chatMessage = {
                sender: user.userId,
                content: messageContent,
                postNum: postNum
            };
            
            console.log("ğŸ“¤ Sending message to /app/chat/" + postNum, chatMessage);
            
            stompClient.send("/app/chat/" + postNum, {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
    }

    function displayMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message');
		
        // ë³¸ì¸ ë©”ì‹œì§€ì™€ ë‹¤ë¥¸ ì‚¬ëŒ ë©”ì‹œì§€ êµ¬ë¶„
        if (message.sender === user.userId) {
            messageElement.classList.add('self');
        } else {
            messageElement.classList.add('other');
        }

        const bubble = document.createElement('div');
        bubble.classList.add('bubble');
        bubble.innerHTML = `<div class="sender">${message.sender}</div>${message.content}`;

        messageElement.appendChild(bubble);
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ìœ ì € ëª©ë¡ì— ìœ ì € ì¶”ê°€
    function addUserToList(userId) {
        if (!connectedUsers.has(userId)) {
            connectedUsers.add(userId);
            updateUserListDisplay();
        }
    }

    // ìœ ì € ëª©ë¡ì—ì„œ ìœ ì € ì œê±°
    function removeUserFromList(userId) {
        if (connectedUsers.has(userId)) {
            connectedUsers.delete(userId);
            updateUserListDisplay();
        }
    }

    // ìœ ì € ëª©ë¡ í™”ë©´ ì—…ë°ì´íŠ¸
    function updateUserListDisplay() {
        userList.innerHTML = '';
        console.log(connectedUsers);
        connectedUsers.forEach(userId => {
            const userElement = document.createElement('div');
            userElement.classList.add('user-item');
            userElement.innerHTML = `
                <span class="user-name">${userId}</span>
                <span class="user-status">â—</span>
            `;
            userList.appendChild(userElement);
        });
    }

    // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ (ì…ì¥/í‡´ì¥ ì•Œë¦¼)
    function displaySystemMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('system-message');
        messageElement.innerHTML = `<span class="system-text">${message}</span>`;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // ìœ ì € ì…ì¥ ë©”ì‹œì§€ ì „ì†¡
    function sendUserJoinMessage() {
        if (stompClient && user && user.userId) {
            const joinMessage = {
                type: 'user_join',
                sender: user.userId,
                content: `${user.userId}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.`,
                postNum: postNum
            };
            stompClient.send("/app/chat/" + postNum, {}, JSON.stringify(joinMessage));
        }
    }

    sendMessageBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });

    // í˜ì´ì§€ë¥¼ ë– ë‚  ë•Œ í‡´ì¥ ë©”ì‹œì§€ ì „ì†¡
    window.addEventListener('beforeunload', () => {
        if (stompClient && user && user.userId) {
            const leaveMessage = {
                type: 'user_leave',
                sender: user.userId,
                content: `${user.userId}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.`,
                postNum: postNum
            };
            stompClient.send("/app/chat/" + postNum, {}, JSON.stringify(leaveMessage));
        }
    });

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì›¹ì†Œì¼“ ì—°ê²° ì‹œì‘
    connect();
});
</script>



	<!-- Kakao ì§€ë„ SDK -->
	<script
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=####"></script>

	<!-- CSRF í† í° -->
	<input type="hidden" th:name="${_csrf.parameterName}"
		th:value="${_csrf.token}" id="csrfToken" />


	<script th:inline="javascript">
kakao.maps.load(function init() {
    const el = document.getElementById('map');
    const pathJsonStr = el.dataset.pathjson || '';
    const startLat = Number(el.dataset.startLat) || null;
    const startLng = Number(el.dataset.startLng) || null;
    const postLat  = Number(el.dataset.postLat) || null;
    const postLng  = Number(el.dataset.postLng) || null;
    const etaMin   = Number(el.dataset.eta) || null;

    let path = [];
    if(pathJsonStr){
        try{
            const arr = JSON.parse(pathJsonStr);
            path = arr.map(p => ({lat:Number(p.lat), lng:Number(p.lng)}))
                      .filter(v => !isNaN(v.lat) && !isNaN(v.lng));
        }catch(e){ console.warn('pathJson parse failed', e);}
    }

    const fallback = new kakao.maps.LatLng(37.642383,126.629726);
    const center =
        path.length>0 ? new kakao.maps.LatLng(path[0].lat, path[0].lng) :
        (startLat && startLng) ? new kakao.maps.LatLng(startLat, startLng) :
        (postLat && postLng) ? new kakao.maps.LatLng(postLat, postLng) :
        fallback;

    const map = new kakao.maps.Map(el, { center, level: 4 });

    const startPos =
        path.length>0 ? new kakao.maps.LatLng(path[0].lat, path[0].lng) :
        (startLat && startLng) ? new kakao.maps.LatLng(startLat, startLng) :
        (postLat && postLng) ? new kakao.maps.LatLng(postLat, postLng) : null;

    if(startPos){
        const startMarker = new kakao.maps.Marker({ map, position: startPos, title: 'ì¶œë°œ' });
        document.getElementById('start').textContent = startPos.getLat().toFixed(6)+', '+startPos.getLng().toFixed(6);
    }

    if(path.length >= 2){
        const latLngs = path.map(p => new kakao.maps.LatLng(p.lat, p.lng));
        const line = new kakao.maps.Polyline({
            map, path: latLngs, strokeWeight:3, strokeColor:'#FF0000', strokeOpacity:1.0, strokeStyle:'dashed'
        });
        const endMarker = new kakao.maps.Marker({
            map, position: latLngs[latLngs.length-1], title:'ë„ì°©'
        });
        const bounds = new kakao.maps.LatLngBounds();
        latLngs.forEach(ll => bounds.extend(ll));
        map.setBounds(bounds);


        let meters = 0;
        if(typeof line.getLength==='function') meters = line.getLength();
        else if(kakao.maps.geometry?.spherical?.computeLength) meters = kakao.maps.geometry.spherical.computeLength(line.getPath());
        document.getElementById('distance').textContent = (meters/1000).toFixed(3)+' km';
    }else{
        document.getElementById('distance').textContent = 'ê²½ë¡œ ì—†ìŒ';
    }

    document.getElementById('eta').textContent = etaMin ? Math.floor(etaMin/60)+'ì‹œê°„ '+(etaMin%60)+'ë¶„' : '-';
});
</script>


	<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', () => {
    const joinBtn = document.getElementById('joinBtn');
    const currentSpan = document.getElementById('currentParticipants');
    const maxParticipants = /*[[${post.maxParticipants}]]*/ 0;
    let currentParticipants = /*[[${post.currentParticipants}]]*/ 0;
    const postId = /*[[${post.postNum}]]*/ 0; // The post ID is stored here
    const joinedInitial = /*[[${joined}]]*/ false;
    const userLoggedIn = /*[[${user != null}]]*/ false;
    const token = /*[[${_csrf.token}]]*/ '';
    const header = /*[[${_csrf.headerName}]]*/ '';
    const user = /*[[${user}]]*/ {};

    const modal = document.getElementById('joinModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalClose = document.getElementById('modalClose');

    // ì‹ ê³  ê¸°ëŠ¥ ê´€ë ¨ 
    const reportModal = document.getElementById('reportModal');
    const reportUserName = document.getElementById('reportUserName');
    const reportReason = document.getElementById('reportReason');
    const reportCloseBtn = document.getElementById('reportClose');
    const reportSubmit = document.getElementById('reportSubmit');
    let reportUserId = null;
    
    // ì‹ ê³  ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ í•¨ìˆ˜ (ë™ì  ìƒì„± ë²„íŠ¼ìš©)
    const attachReportButtonEvents = () => {
        document.querySelectorAll('.reportBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                reportUserId = btn.dataset.userId;
                reportUserName.textContent = btn.previousElementSibling.textContent;
                reportReason.value = '';
                reportModal.classList.add('show');
                reportModal.style.display = 'flex';
            });
        });
    };
    
    // ëª¨ë‹¬ í‘œì‹œ í•¨ìˆ˜
    const showModal = (message) => {
        modalMessage.textContent = message;
        modal.classList.add('show');
        modal.style.display = 'flex';
    };

    // ëª¨ë‹¬ ë‹«ê¸° í•¨ìˆ˜
    const closeModal = () => {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    };

    modalClose.addEventListener('click', closeModal);
    
    // ì°¸ê°€ì ëª©ë¡ì„ ë™ì ìœ¼ë¡œ ì—…ë°ì´íŠ¸í•˜ëŠ” í•¨ìˆ˜
    const updateParticipantsList = (participants) => {
        const participantsListUl = document.querySelector('ul');
        participantsListUl.innerHTML = ''; // ê¸°ì¡´ ëª©ë¡ì„ ë¹„ì›ë‹ˆë‹¤.

        participants.forEach(p => {
            const li = document.createElement('li');
            const span = document.createElement('span');
            span.textContent = p.userId;
            li.appendChild(span);

            // ë¡œê·¸ì¸ ìƒíƒœì´ê³ , ìê¸° ìì‹ ì´ ì•„ë‹ˆê³ , ë¸”ë¡ë˜ì§€ ì•Šì•˜ì„ ë•Œë§Œ ì‹ ê³  ë²„íŠ¼ ìƒì„±
            if (userLoggedIn && user.userNum !== p.userNum && !user.isBlocked) {
                const reportBtn = document.createElement('button');
                reportBtn.className = 'btn reportBtn';
                reportBtn.textContent = 'ì‹ ê³ ';
                reportBtn.dataset.userId = p.userNum;
                li.appendChild(reportBtn);
            }
            participantsListUl.appendChild(li);
        });

        // ìƒˆë¡œìš´ ì‹ ê³  ë²„íŠ¼ì— ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆë¥¼ ë‹¤ì‹œ ì—°ê²°í•©ë‹ˆë‹¤.
        attachReportButtonEvents();
    };

    if (userLoggedIn) {
        // ìµœì´ˆ ë²„íŠ¼ ìƒíƒœ
        if (currentParticipants >= maxParticipants && !joinedInitial) {
            joinBtn.disabled = true;
            joinBtn.textContent = "ë§ˆê°";
        } else {
            joinBtn.textContent = joinedInitial ? 'ì°¸ì—¬ ì·¨ì†Œ' : 'ì°¸ì—¬í•˜ê¸°';
        }

        joinBtn.addEventListener('click', () => {
            const action = joinBtn.textContent.includes('ì·¨ì†Œ') ? 'cancel' : 'join';

            fetch(`/community/running/${postId}/${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                },
                body: JSON.stringify({}) // ë°˜ë“œì‹œ body í•„ìš”
            })
            .then(res => res.json().then(data => ({ ok: res.ok, status: res.status, body: data })))
            .then(resData => {
                if (!resData.ok) {
                    const msg = resData.body?.message || `ì°¸ì—¬/ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜(${resData.status})`;
                    showModal(msg);
                    return;
                }

                const data = resData.body;
                currentParticipants = data.currentParticipants;
                
                // ì°¸ê°€ì ëª©ë¡ ì—…ë°ì´íŠ¸ í•¨ìˆ˜ í˜¸ì¶œ
                if (data.participants) {
                    updateParticipantsList(data.participants);
                }

                // ë²„íŠ¼ ìƒíƒœ ê°±ì‹ 
                if (action === 'join' && currentParticipants >= maxParticipants) {
                    joinBtn.textContent = data.joined ? 'ì°¸ì—¬ ì·¨ì†Œ' : 'ë§ˆê°';
                    joinBtn.disabled = !data.joined;
                } else {
                    joinBtn.textContent = data.joined ? 'ì°¸ì—¬ ì·¨ì†Œ' : 'ì°¸ì—¬í•˜ê¸°';
                    joinBtn.disabled = false;
                }

                currentSpan.textContent = data.currentParticipants;
                
                showModal(action === 'join' ? 'ì°¸ì—¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.' : 'ì°¸ì—¬ê°€ ì·¨ì†Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            })
            .catch(err => {
                console.error(err);
                showModal('ì°¸ì—¬/ì·¨ì†Œ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            });
        });
    }

    //  DOMContentLoaded ì‹œì ì˜ ë²„íŠ¼ì—ë§Œ ì´ë²¤íŠ¸ ì—°ê²°
    reportCloseBtn.addEventListener('click', () => {
        reportModal.classList.remove('show');
        setTimeout(() => reportModal.style.display = 'none', 300);
    });

    reportSubmit.addEventListener('click', () => {
        const reason = reportReason.value.trim();
        if (!reason) { alert('ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }

        reportSubmit.disabled = true;

        fetch(`/community/running/${postId}/report/${reportUserId}`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                [header]: token
            },
            body: JSON.stringify({ reason: reason })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) { alert('ì‹ ê³ ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤.'); } 
            else { alert(data.message || 'ì‹ ê³  ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜'); }
        })
        .catch(err => {
            console.error(err);
            alert('ì‹ ê³  ì²˜ë¦¬ ì¤‘ í†µì‹  ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .finally(() => {
            reportSubmit.disabled = false;
            reportModal.classList.remove('show');
            setTimeout(() => reportModal.style.display = 'none', 300);
        });
    });
    
    // ì´ˆê¸° í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹ ê³  ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
    attachReportButtonEvents();

});
</script>

	<div id="joinModal" class="modal">
		<div class="modal-content">
			<p id="modalMessage">ì°¸ì—¬/ì·¨ì†Œ ì²˜ë¦¬ ì¤‘...</p>
			<button id="modalClose">í™•ì¸</button>
		</div>
	</div>

	<div id="reportModal" class="modal">
		<div class="modal-content">
			<h4>ìœ ì € ì‹ ê³ </h4>
			<p id="reportUserName"></p>
			<textarea id="reportReason" placeholder="ì‹ ê³  ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”"></textarea>
			<br /> <br />
			<div class="modal-actions">
			  <button id="reportSubmit" class="btn">ì‹ ê³ í•˜ê¸°</button>
			  <button id="reportClose" class="btn">ì·¨ì†Œ</button>
			</div>
		</div>
	</div>
</div>
</body>
</html>
