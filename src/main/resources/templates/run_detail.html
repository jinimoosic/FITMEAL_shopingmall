<!doctype html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org"
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
	xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
	layout:decorate="~{layout}">
<head>


<meta charset="utf-8" />
<title th:text="${post.title}">러닝 모집 상세</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
body {
	font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica,
		Arial, sans-serif;

}

.grid {
	display: grid;
	grid-template-columns: 4fr 3fr 3fr;
	gap: 24px;
	align-items: stretch;
}

.card {
	border: 1px solid #ddd;
	border-radius: 8px;
	padding: 16px;
	position: relative;
}

.card-footer {
	position: absolute;
	bottom: 16px;
	left: 16px;
	right: 16px;
	display: flex;
	align-items: center;
	gap: 12px;
}

.card-footer .btn {
	padding: 10px 15px;
	border-radius: 4px;
	background-color: #111;
	color: #fff;
	border: none;
	cursor: pointer;
	flex: none;
}

.footer-text {
	font-size: 14px;
	color: #666;
}

.content-card {
	border: 1px solid #ddd;
	border-radius: 12px;
	background: #fff;
	box-shadow: 0 2px 6px rgba(0, 0, 0, 0.08);
	padding: 8px;
	margin-bottom: 16px;
}

.content-card textarea {
	width: 100%;
	height: 120px;
	padding: 12px;
	border: none;
	outline: none;
	resize: none;
	font-size: 14px;
	line-height: 1.5;
	background: transparent;
}

#map {
	width: 100%;
	height: 520px;
	border-radius: 12px
}

.btn {
	background: #111;
	color: #fff;
	border: none;
	border-radius: 10px;
	padding: 12px 16px;
	cursor: pointer
}

.btn:disabled {
	opacity: .5;
	cursor: not-allowed
}

.stats {
	display: flex;
	gap: 12px;
	flex-wrap: wrap;
	margin-top: 8px
}

.stats div {
	background: #fafafa;
	border: 1px solid #eee;
	border-radius: 10px;
	padding: 8px 10px;
	font-size: 14px
}

.muted {
	color: #666
}

.time-range {
	font-size: 1.2em;
	font-weight: 600;
	color: #111;
}

.modal {
	display: none;
	position: fixed;
	top: 0;
	left: 0;
	width: 100%;
	height: 100%;
	background: rgba(0, 0, 0, 0.5);
	justify-content: center;
	align-items: center;
	z-index: 1000;
	opacity: 0;
	transition: opacity 0.3s ease;
}

.modal-content {
	background: #fff;
	padding: 20px;
	border-radius: 12px;
	max-width: 400px;
	width: 90%;
	text-align: center;
	transform: translateY(-20px);
	transition: transform 0.3s ease;
}

.modal-content .modal-actions {
    display: flex;
    justify-content: center; 
    gap: 12px;              
    margin-top: 16px;
}

.modal-content .modal-actions button {
    flex: none;             
    padding: 12px 18px;     
    font-size: 14px;        
    line-height: 1.2;       
    white-space: nowrap;      
    border-radius: 6px;
    cursor: pointer;
}

.modal.show {
	display: flex;
	opacity: 1;
}

.modal.show .modal-content {
	transform: translateY(0);
}

#modalClose {
	margin-top: 12px;
	padding: 8px 16px;
	border: none;
	border-radius: 8px;
	background: #111;
	color: #fff;
	cursor: pointer;
}

.reportBtn {
	background-color: #f0f0f0;
	color: #555;
	border: 1px solid #ccc;
	border-radius: 6px;
	padding: 3px 7px;
	font-size: 12px;
	cursor: pointer;
	transition: all 0.2s ease;
	margin-left: 8px;
}

.reportBtn:hover {
	background-color: #e0e0e0;
	border-color: #bbb;
}

.list-btn {
	display: inline-block;
	padding: 8px 16px;
	font-size: 16px;
	font-weight: 500;
	color: #1a73e8;
	border: 2px solid #1a73e8;
	border-radius: 6px;
	background: #fff;
	cursor: pointer;
	transition: all 0.2s ease;
	text-decoration: none;
}

.list-btn:hover {
	background-color: #1a73e8;
	color: #fff;
}
.delete-btn {
    display: inline-block;
    padding: 8px 16px;
    font-size: 16px;
    font-weight: 500;
    color: #dc3545;
    border: 2px solid #dc3545;
    border-radius: 6px;
    background: #fff;
    cursor: pointer;
    transition: all 0.2s ease;
    text-decoration: none;
    margin-left: 8px; 
}

.delete-btn:hover {
    background-color: #dc3545; 
    color: #fff;
}

.chat-container {
	display: flex;
	flex-direction: column;
	height: 100%;
}

.chat-header {
	font-weight: bold;
	padding: 8px 0;
	margin-bottom: 8px;
}

.chat-messages {
	flex: 1;
	overflow-y: auto;
	padding: 10px;
	border-top: 1px solid #ddd;
	border-bottom: 1px solid #ddd;
}

.chat-message {
	margin-bottom: 10px;
	display: flex;
}

.chat-message .bubble {
	max-width: 70%;
	padding: 10px 14px;
	border-radius: 16px;
	line-height: 1.4;
}

.chat-message.self {
	justify-content: flex-end;
}

.chat-message.self .bubble {
	background: #111;
	color: #fff;
	border-bottom-right-radius: 4px;
}

.chat-message.other .bubble {
	background: #e9ecef;
	color: #333;
	border-bottom-left-radius: 4px;
}

.chat-message .sender {
	font-size: 12px;
	margin-bottom: 4px;
	color: #666;
}

.chat-input {
	display: flex;
	gap: 8px;
	margin-top: 8px;
}

.chat-input input {
	flex: 1;
	padding: 8px 10px;
	border: 1px solid #ccc;
	border-radius: 6px;
	outline: none;
	font-size: 14px;
	box-sizing: border-box;
}

.chat-input button {
	padding: 8px 14px;
	border: none;
	border-radius: 6px;
	background-color: #000;
	color: #fff;
	cursor: pointer;
	transition: background 0.2s;
}

.chat-input button:hover {
	background-color: #333;
}

.user-item {
	display: flex;
	justify-content: space-between;
	align-items: center;
	padding: 8px 12px;
	margin-bottom: 4px;
	background: #f8f9fa;
	border-radius: 6px;
	border: 1px solid #e9ecef;
}

.user-name {
	font-weight: 500;
	color: #333;
	font-size: 14px;
}

.user-status {
	color: #28a745;
	font-size: 12px;
}

.system-message {
	text-align: center;
	margin: 8px 0;
}

.system-text {
	background: #e3f2fd;
	color: #1976d2;
	padding: 4px 12px;
	border-radius: 12px;
	font-size: 12px;
	font-weight: 500;
}
</style>
</head>
<body>
	<div layout:fragment="content">
<div style="display: inline-flex; align-items: center; gap: 8px; margin-bottom: 16px;">
    <h1 th:text="${post.title}" style="margin: 0; font-size: 1.8em;">러닝 모집 상세</h1>

    <th:block th:if="${canDelete}">
        <form th:action="@{|/community/running/run_delete/${post.postNum}|}" method="post" style="display:inline;">
            <button type="submit" class="delete-btn"
                style="padding: 4px 10px; font-size: 14px;" 
                onclick="return confirm('정말 삭제하시겠습니까?');">
                삭제
            </button>
        </form>
        <span style="color: #555; font-size: 13px;">참여자가 없을 때만 삭제 가능합니다!</span>
    </th:block>
</div>

	<div class="grid">
		<!-- 지도 섹션 -->
		<section class="card">
			<h2>코스 지도</h2>
			<div id="map"
				th:attr="data-pathjson=${course != null ? course.pathJson : null},
                  data-start-lat=${course != null ? course.startLat : null},
                  data-start-lng=${course != null ? course.startLng : null},
                  data-post-lat=${post.locationLat},
                  data-post-lng=${post.locationLng},
                  data-eta=${course != null ? course.estimatedTime : null}">
			</div>
			<div class="stats">
				<div>
					총 거리: <span id="distance">-</span>
				</div>
				<div>
					예상 시간: <span id="eta">-</span>
				</div>
				
				<div>
					시작 좌표: <span id="start">-</span>
				</div>

			</div>
		</section>

		<!-- 정보 섹션 -->
		<aside class="card" style="padding-bottom: 60px;">
			<div class="card-body">

				<!-- 종료된 모임 안내 -->
				<div th:if="${#temporals.createNow().isAfter(post.endTime)}"
					style="padding: 12px; background: #f8d7da; color: #842029; border-radius: 8px; margin-bottom: 16px;">
					종료된 모임입니다.</div>

				
<p class="muted"
    th:text="${#temporals.format(post.createDate, 'yyyy-MM-dd HH:mm')} + '에 작성된 글'">
    작성일
</p>


				<!-- 내용 -->
				<div class="content-card">
					<textarea readonly th:text="${post.content}"></textarea>
				</div>

				<p>
					<b>날짜</b>: <span
						th:text="${#temporals.format(post.date, 'yyyy-MM-dd')}"></span>
				</p>
				<p>
					<b>시작</b>: <span
						th:text="${post.startTime != null ? post.startTime.toLocalTime() : '-'}"></span>
				</p>
				<p>
					<b>종료</b>: <span
						th:text="${post.endTime != null ? post.endTime.toLocalTime() : '-'}"></span>
				</p>
				<p>
					<b>최대 인원</b>: <span th:text="${post.maxParticipants}">-</span>
				</p>
				<p>
					<b>현재 인원</b>: <span id="currentParticipants"
						th:text="${post.currentParticipants}">-</span>
				</p>


				<ul>
					<li th:each="participant : ${participants}"><span
						th:text="${participant.userId}">사용자 이름</span>

						<button class="btn reportBtn"
							th:data-user-id="${participant.userNum}"
							th:if="${user != null and !user.isBlocked and user.userNum != participant.userNum}">
							신고</button></li>
				</ul>

				<!-- 참여/취소 버튼 -->
				<div class="card-footer">
					<button id="joinBtn" class="btn"
						th:text="${joined} ? '참여 취소' : '참여하기'"
						th:disabled="${user == null 
                     or (user != null and user.isBlocked) or (isHost != null and isHost) 
                     or #temporals.createNow().isAfter(post.endTime) 
                     or (post.currentParticipants == post.maxParticipants and !joined)}">
					</button>

					<p th:if="${user == null}" style="color: red; margin-top: 8px;">로그인
						후 참여 가능합니다.</p>
					<p th:if="${isHost}" style="color: gray; margin-top: 8px;">작성자는
						참여 취소할 수 없습니다.</p>
					<p th:if="${user != null and user.isBlocked}"
						style="color: red; margin-top: 8px;">경고 누적으로 인해 러닝 참여가 불가합니다.</p>
				</div>

			</div>


		</aside>

		<!-- 로그인된 사용자만 채팅방 표시 -->
		<aside class="card" sec:authorize="isAuthenticated()">
			<!-- user list -->
			<div class="chat-container" style="height:45%">
				<div class="chat-header">유저 목록</div>
				<div class="chat-messages" id="userList"></div>
			</div>
			<!-- 실시간 채팅 -->
			<div class="chat-container" style="height:45%">
				<div class="chat-header">실시간 채팅</div>
				<div class="chat-messages" id="chatMessages"></div>
				<div class="chat-input">
					<input type="text" id="messageInput" placeholder="메시지 입력..." />
					<button id="sendMessageBtn">전송</button>
				</div>
			</div>
		</aside>

		<!-- 로그인되지 않은 사용자에게 표시할 메시지 -->
		<aside class="card" sec:authorize="!isAuthenticated()">
			<div class="chat-container">
				<div class="chat-header">실시간 채팅</div>
				<div class="chat-messages" style="text-align: center; padding: 20px; color: #666;">
					<p>채팅 기능을 이용하려면 로그인이 필요합니다.</p>
					<a th:href="@{/users/login}" class="btn btn-primary">로그인하기</a>
				</div>
			</div>
		</aside>

	</div>

	<!-- 카드 밖 버튼 -->
	<div style="text-align: center; margin-top: 24px;">
		<a th:href="@{/community/running}" class="list-btn"> 목록보기 </a>
	</div>





	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/sockjs-client/1.5.0/sockjs.min.js"></script>
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js"></script>

	<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', () => {

    const postNum = /*[[${post.postNum}]]*/ 0;
    const user = /*[[${user}]]*/ {};
    const isAuthenticated = /*[[${#authentication != null}]]*/ false;
	
    // 로그인되지 않은 경우 채팅 기능 비활성화
    if (!isAuthenticated || !user || !user.userId) {
        console.log('사용자가 로그인되지 않았습니다. 채팅 기능이 비활성화됩니다.');
        return;
    }
    console.log(user);

    const chatMessages = document.getElementById('chatMessages');
    const messageInput = document.getElementById('messageInput');
    const sendMessageBtn = document.getElementById('sendMessageBtn');
    const userList = document.getElementById('userList');

    // 채팅 요소가 존재하지 않으면 종료
    if (!chatMessages || !messageInput || !sendMessageBtn || !userList) {
        console.log('채팅 요소를 찾을 수 없습니다.');
        return;
    }

    let stompClient = null;
    let connectedUsers = new Set(); // 연결된 유저 목록

    function connect() {
        const socket = new SockJS('/ws');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, onConnected);
    }
    
    function onConnected() {
        console.log('✅ WebSocket Connected!');
        stompClient.subscribe('/topic/' + postNum, onMessageReceived);
        
        // 현재 유저를 목록에 추가
        addUserToList(user.userId);
        
        // 유저 입장 알림 메시지 전송
        sendUserJoinMessage();
    }

    function onMessageReceived(payload) {
        console.log("📩 Message Received:", payload.body);
        const message = JSON.parse(payload.body);
        
        // 메시지 타입에 따라 처리
        if (message.type === 'user_join') {
			console.log('!!!!!',message.users);
			if(message.users){
				message.users.forEach(id=>addUserToList(id))
			}
            //addUserToList(message.sender);
            displaySystemMessage(`${message.sender}님이 입장했습니다.`);
        } else if (message.type === 'user_leave') {
            removeUserFromList(message.sender);
            displaySystemMessage(`${message.sender}님이 퇴장했습니다.`);
        } else {
            displayMessage(message);
        }
    }

    function sendMessage() {
        const messageContent = messageInput.value.trim();
        if (messageContent && stompClient && user && user.userId) {
            const chatMessage = {
                sender: user.userId,
                content: messageContent,
                postNum: postNum
            };
            
            console.log("📤 Sending message to /app/chat/" + postNum, chatMessage);
            
            stompClient.send("/app/chat/" + postNum, {}, JSON.stringify(chatMessage));
            messageInput.value = '';
        }
    }

    function displayMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('chat-message');
		
        // 본인 메시지와 다른 사람 메시지 구분
        if (message.sender === user.userId) {
            messageElement.classList.add('self');
        } else {
            messageElement.classList.add('other');
        }

        const bubble = document.createElement('div');
        bubble.classList.add('bubble');
        bubble.innerHTML = `<div class="sender">${message.sender}</div>${message.content}`;

        messageElement.appendChild(bubble);
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // 유저 목록에 유저 추가
    function addUserToList(userId) {
        if (!connectedUsers.has(userId)) {
            connectedUsers.add(userId);
            updateUserListDisplay();
        }
    }

    // 유저 목록에서 유저 제거
    function removeUserFromList(userId) {
        if (connectedUsers.has(userId)) {
            connectedUsers.delete(userId);
            updateUserListDisplay();
        }
    }

    // 유저 목록 화면 업데이트
    function updateUserListDisplay() {
        userList.innerHTML = '';
        console.log(connectedUsers);
        connectedUsers.forEach(userId => {
            const userElement = document.createElement('div');
            userElement.classList.add('user-item');
            userElement.innerHTML = `
                <span class="user-name">${userId}</span>
                <span class="user-status">●</span>
            `;
            userList.appendChild(userElement);
        });
    }

    // 시스템 메시지 표시 (입장/퇴장 알림)
    function displaySystemMessage(message) {
        const messageElement = document.createElement('div');
        messageElement.classList.add('system-message');
        messageElement.innerHTML = `<span class="system-text">${message}</span>`;
        chatMessages.appendChild(messageElement);
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }

    // 유저 입장 메시지 전송
    function sendUserJoinMessage() {
        if (stompClient && user && user.userId) {
            const joinMessage = {
                type: 'user_join',
                sender: user.userId,
                content: `${user.userId}님이 입장했습니다.`,
                postNum: postNum
            };
            stompClient.send("/app/chat/" + postNum, {}, JSON.stringify(joinMessage));
        }
    }

    sendMessageBtn.addEventListener('click', sendMessage);
    messageInput.addEventListener('keydown', (event) => {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });

    // 페이지를 떠날 때 퇴장 메시지 전송
    window.addEventListener('beforeunload', () => {
        if (stompClient && user && user.userId) {
            const leaveMessage = {
                type: 'user_leave',
                sender: user.userId,
                content: `${user.userId}님이 퇴장했습니다.`,
                postNum: postNum
            };
            stompClient.send("/app/chat/" + postNum, {}, JSON.stringify(leaveMessage));
        }
    });

    // 페이지 로드 시 웹소켓 연결 시작
    connect();
});
</script>



	<!-- Kakao 지도 SDK -->
	<script
		src="//dapi.kakao.com/v2/maps/sdk.js?appkey=####"></script>

	<!-- CSRF 토큰 -->
	<input type="hidden" th:name="${_csrf.parameterName}"
		th:value="${_csrf.token}" id="csrfToken" />


	<script th:inline="javascript">
kakao.maps.load(function init() {
    const el = document.getElementById('map');
    const pathJsonStr = el.dataset.pathjson || '';
    const startLat = Number(el.dataset.startLat) || null;
    const startLng = Number(el.dataset.startLng) || null;
    const postLat  = Number(el.dataset.postLat) || null;
    const postLng  = Number(el.dataset.postLng) || null;
    const etaMin   = Number(el.dataset.eta) || null;

    let path = [];
    if(pathJsonStr){
        try{
            const arr = JSON.parse(pathJsonStr);
            path = arr.map(p => ({lat:Number(p.lat), lng:Number(p.lng)}))
                      .filter(v => !isNaN(v.lat) && !isNaN(v.lng));
        }catch(e){ console.warn('pathJson parse failed', e);}
    }

    const fallback = new kakao.maps.LatLng(37.642383,126.629726);
    const center =
        path.length>0 ? new kakao.maps.LatLng(path[0].lat, path[0].lng) :
        (startLat && startLng) ? new kakao.maps.LatLng(startLat, startLng) :
        (postLat && postLng) ? new kakao.maps.LatLng(postLat, postLng) :
        fallback;

    const map = new kakao.maps.Map(el, { center, level: 4 });

    const startPos =
        path.length>0 ? new kakao.maps.LatLng(path[0].lat, path[0].lng) :
        (startLat && startLng) ? new kakao.maps.LatLng(startLat, startLng) :
        (postLat && postLng) ? new kakao.maps.LatLng(postLat, postLng) : null;

    if(startPos){
        const startMarker = new kakao.maps.Marker({ map, position: startPos, title: '출발' });
        document.getElementById('start').textContent = startPos.getLat().toFixed(6)+', '+startPos.getLng().toFixed(6);
    }

    if(path.length >= 2){
        const latLngs = path.map(p => new kakao.maps.LatLng(p.lat, p.lng));
        const line = new kakao.maps.Polyline({
            map, path: latLngs, strokeWeight:3, strokeColor:'#FF0000', strokeOpacity:1.0, strokeStyle:'dashed'
        });
        const endMarker = new kakao.maps.Marker({
            map, position: latLngs[latLngs.length-1], title:'도착'
        });
        const bounds = new kakao.maps.LatLngBounds();
        latLngs.forEach(ll => bounds.extend(ll));
        map.setBounds(bounds);


        let meters = 0;
        if(typeof line.getLength==='function') meters = line.getLength();
        else if(kakao.maps.geometry?.spherical?.computeLength) meters = kakao.maps.geometry.spherical.computeLength(line.getPath());
        document.getElementById('distance').textContent = (meters/1000).toFixed(3)+' km';
    }else{
        document.getElementById('distance').textContent = '경로 없음';
    }

    document.getElementById('eta').textContent = etaMin ? Math.floor(etaMin/60)+'시간 '+(etaMin%60)+'분' : '-';
});
</script>


	<script th:inline="javascript">
document.addEventListener('DOMContentLoaded', () => {
    const joinBtn = document.getElementById('joinBtn');
    const currentSpan = document.getElementById('currentParticipants');
    const maxParticipants = /*[[${post.maxParticipants}]]*/ 0;
    let currentParticipants = /*[[${post.currentParticipants}]]*/ 0;
    const postId = /*[[${post.postNum}]]*/ 0; // The post ID is stored here
    const joinedInitial = /*[[${joined}]]*/ false;
    const userLoggedIn = /*[[${user != null}]]*/ false;
    const token = /*[[${_csrf.token}]]*/ '';
    const header = /*[[${_csrf.headerName}]]*/ '';
    const user = /*[[${user}]]*/ {};

    const modal = document.getElementById('joinModal');
    const modalMessage = document.getElementById('modalMessage');
    const modalClose = document.getElementById('modalClose');

    // 신고 기능 관련 
    const reportModal = document.getElementById('reportModal');
    const reportUserName = document.getElementById('reportUserName');
    const reportReason = document.getElementById('reportReason');
    const reportCloseBtn = document.getElementById('reportClose');
    const reportSubmit = document.getElementById('reportSubmit');
    let reportUserId = null;
    
    // 신고 버튼 이벤트 리스너 함수 (동적 생성 버튼용)
    const attachReportButtonEvents = () => {
        document.querySelectorAll('.reportBtn').forEach(btn => {
            btn.addEventListener('click', () => {
                reportUserId = btn.dataset.userId;
                reportUserName.textContent = btn.previousElementSibling.textContent;
                reportReason.value = '';
                reportModal.classList.add('show');
                reportModal.style.display = 'flex';
            });
        });
    };
    
    // 모달 표시 함수
    const showModal = (message) => {
        modalMessage.textContent = message;
        modal.classList.add('show');
        modal.style.display = 'flex';
    };

    // 모달 닫기 함수
    const closeModal = () => {
        modal.classList.remove('show');
        setTimeout(() => modal.style.display = 'none', 300);
    };

    modalClose.addEventListener('click', closeModal);
    
    // 참가자 목록을 동적으로 업데이트하는 함수
    const updateParticipantsList = (participants) => {
        const participantsListUl = document.querySelector('ul');
        participantsListUl.innerHTML = ''; // 기존 목록을 비웁니다.

        participants.forEach(p => {
            const li = document.createElement('li');
            const span = document.createElement('span');
            span.textContent = p.userId;
            li.appendChild(span);

            // 로그인 상태이고, 자기 자신이 아니고, 블록되지 않았을 때만 신고 버튼 생성
            if (userLoggedIn && user.userNum !== p.userNum && !user.isBlocked) {
                const reportBtn = document.createElement('button');
                reportBtn.className = 'btn reportBtn';
                reportBtn.textContent = '신고';
                reportBtn.dataset.userId = p.userNum;
                li.appendChild(reportBtn);
            }
            participantsListUl.appendChild(li);
        });

        // 새로운 신고 버튼에 이벤트 리스너를 다시 연결합니다.
        attachReportButtonEvents();
    };

    if (userLoggedIn) {
        // 최초 버튼 상태
        if (currentParticipants >= maxParticipants && !joinedInitial) {
            joinBtn.disabled = true;
            joinBtn.textContent = "마감";
        } else {
            joinBtn.textContent = joinedInitial ? '참여 취소' : '참여하기';
        }

        joinBtn.addEventListener('click', () => {
            const action = joinBtn.textContent.includes('취소') ? 'cancel' : 'join';

            fetch(`/community/running/${postId}/${action}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    [header]: token
                },
                body: JSON.stringify({}) // 반드시 body 필요
            })
            .then(res => res.json().then(data => ({ ok: res.ok, status: res.status, body: data })))
            .then(resData => {
                if (!resData.ok) {
                    const msg = resData.body?.message || `참여/취소 처리 중 오류(${resData.status})`;
                    showModal(msg);
                    return;
                }

                const data = resData.body;
                currentParticipants = data.currentParticipants;
                
                // 참가자 목록 업데이트 함수 호출
                if (data.participants) {
                    updateParticipantsList(data.participants);
                }

                // 버튼 상태 갱신
                if (action === 'join' && currentParticipants >= maxParticipants) {
                    joinBtn.textContent = data.joined ? '참여 취소' : '마감';
                    joinBtn.disabled = !data.joined;
                } else {
                    joinBtn.textContent = data.joined ? '참여 취소' : '참여하기';
                    joinBtn.disabled = false;
                }

                currentSpan.textContent = data.currentParticipants;
                
                showModal(action === 'join' ? '참여가 완료되었습니다.' : '참여가 취소되었습니다.');
            })
            .catch(err => {
                console.error(err);
                showModal('참여/취소 처리 중 오류가 발생했습니다.');
            });
        });
    }

    //  DOMContentLoaded 시점의 버튼에만 이벤트 연결
    reportCloseBtn.addEventListener('click', () => {
        reportModal.classList.remove('show');
        setTimeout(() => reportModal.style.display = 'none', 300);
    });

    reportSubmit.addEventListener('click', () => {
        const reason = reportReason.value.trim();
        if (!reason) { alert('신고 사유를 입력해주세요.'); return; }

        reportSubmit.disabled = true;

        fetch(`/community/running/${postId}/report/${reportUserId}`, {
            method: 'POST',
            headers: { 
                'Content-Type': 'application/json',
                [header]: token
            },
            body: JSON.stringify({ reason: reason })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) { alert('신고가 접수되었습니다.'); } 
            else { alert(data.message || '신고 처리 중 오류'); }
        })
        .catch(err => {
            console.error(err);
            alert('신고 처리 중 통신 오류가 발생했습니다.');
        })
        .finally(() => {
            reportSubmit.disabled = false;
            reportModal.classList.remove('show');
            setTimeout(() => reportModal.style.display = 'none', 300);
        });
    });
    
    // 초기 페이지 로드 시 신고 버튼 이벤트 연결
    attachReportButtonEvents();

});
</script>

	<div id="joinModal" class="modal">
		<div class="modal-content">
			<p id="modalMessage">참여/취소 처리 중...</p>
			<button id="modalClose">확인</button>
		</div>
	</div>

	<div id="reportModal" class="modal">
		<div class="modal-content">
			<h4>유저 신고</h4>
			<p id="reportUserName"></p>
			<textarea id="reportReason" placeholder="신고 사유를 입력해주세요"></textarea>
			<br /> <br />
			<div class="modal-actions">
			  <button id="reportSubmit" class="btn">신고하기</button>
			  <button id="reportClose" class="btn">취소</button>
			</div>
		</div>
	</div>
</div>
</body>
</html>
